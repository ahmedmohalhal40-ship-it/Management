<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ´ÙˆÙØ§Øª</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --bg: #f4f7f6; }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: var(--bg); padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background: var(--primary); color: white; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 2px; }
        .btn-show { background: #3498db; color: white; }
        .btn-word { background: #27ae60; color: white; }
        
        /* Ø§Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { background: white; width: 80%; max-width: 700px; margin: 50px auto; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto; }
        .close-btn { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 5px; float: left; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container" id="adminBox">
        <h2>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ´ÙˆÙØ§Øª ğŸ“‹</h2>
        <table id="activitiesTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø¹Ø±Ø¶ / ØªØ­Ù…ÙŠÙ„</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚ X</span>
            <h3 id="modalTitle"></h3>
            <div id="modalBody"></div>
            <button class="btn btn-word" onclick="exportCurrentToWord()">ØªØ­Ù…ÙŠÙ„ ÙƒÙ…Ù„Ù Word</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://avikwgcqddywzqajumrn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2aWt3Z2NxZGR5d3pxYWp1bXJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjQxODUsImV4cCI6MjA4NjUwMDE4NX0.ku71P-PCxZGTGI3gLO0odcu85HC-I9_L89f3zNvw8Jk';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentData = { title: '', date: '', students: [] };

        async function loadActivities() {
            const { data } = await _supabase.from('activities').select('*').order('created_at', {ascending: false});
            const tbody = document.querySelector('#activitiesTable tbody');
            tbody.innerHTML = '';
            data.forEach(act => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${act.title}</td>
                    <td>${act.activity_date}</td>
                    <td>
                        <button class="btn btn-show" onclick="viewStudents('${act.id}', '${act.title}', '${act.activity_date}')">Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function viewStudents(id, title, date) {
            const { data: regs } = await _supabase.from('registrations').select('profiles(*)').eq('activity_id', id);
            
            currentData = {
                title: title,
                date: date,
                students: regs.map((r, i) => ({
                    index: i + 1,
                    name: r.profiles.full_name,
                    phone: r.profiles.phone,
                    major: r.profiles.major,
                    year: r.profiles.academic_year
                }))
            };

            let tableHtml = `
                <table id="exportTable" border="1" style="width:100%; border-collapse:collapse; margin-top:10px;">
                    <tr style="background:#eee;"><th>Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th>Ø§Ù„ÙØ±Ù‚Ø©</th></tr>
                    ${currentData.students.map(s => `<tr><td>${s.index}</td><td>${s.name}</td><td>${s.phone}</td><td>${s.major}</td><td>${s.year}</td></tr>`).join('')}
                </table>`;
            
            document.getElementById('modalTitle').innerText = "ÙƒØ´Ù: " + title;
            document.getElementById('modalBody').innerHTML = tableHtml;
            document.getElementById('modal').style.display = 'block';
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function exportCurrentToWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40' lang='ar' dir='rtl'><head><meta charset='utf-8'><title>Export</title></head><body>";
            const footer = "</body></html>";
            
            // ØªØµÙ…ÙŠÙ… Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù
            const content = `
                <div style="text-align:center; direction:rtl;">
                    <h2>Ù†Ø´Ø§Ø·: ${currentData.title}</h2>
                    <p>Ø¨ØªØ§Ø±ÙŠØ®: ${currentData.date}</p>
                    ${document.getElementById('modalBody').innerHTML}
                </div>`;

            const sourceHTML = header + content + footer;
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = `ÙƒØ´Ù_${currentData.title}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        loadActivities();
    </script>
</body>
</html>
