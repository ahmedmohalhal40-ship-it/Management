<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استعادة الحساب | منصة الطلاب</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --bg: #f4f7f6;
            --white: #fff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; }

        .reset-box {
            background: var(--white);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .reset-box h2 { color: var(--primary); margin-bottom: 10px; }
        .reset-box p { font-size: 14px; color: #666; margin-bottom: 25px; }

        .input-group { text-align: right; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            outline: none;
            transition: 0.3s;
            text-align: center;
        }
        input:focus { border-color: var(--secondary); }

        .btn-verify {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .back-link { display: block; margin-top: 15px; text-decoration: none; color: #7f8c8d; font-size: 13px; }
    </style>
</head>
<body>

    <div class="reset-box">
        <h2>نسيت كلمة السر؟</h2>
        <p>أدخل بياناتك المسجلة للتأكد من هويتك وإرسال طلب للأدمن</p>

        <div class="input-group">
            <label>الاسم الكامل (كما سجلته أول مرة)</label>
            <input type="text" id="verifyName" placeholder="اكتب اسمك الثلاثي/الرباعي">
        </div>

        <div class="input-group">
            <label>رقم الهاتف (واتساب)</label>
            <input type="tel" id="verifyPhone" placeholder="01xxxxxxxxx">
        </div>

        <button class="btn-verify" onclick="verifyAndSend()">تحقق من البيانات</button>

        <a href="index.html" class="back-link">العودة لتسجيل الدخول</a>
    </div>

    <script>
        const SUPABASE_URL = 'https://avikwgcqddywzqajumrn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF2aWt3Z2NxZGR5d3pxYWp1bXJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjQxODUsImV4cCI6MjA4NjUwMDE4NX0.ku71P-PCxZGTGI3gLO0odcu85HC-I9_L89f3zNvw8Jk';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // وظيفة تنظيف النص من الهمزات والنقاط
        function cleanText(text) {
            if (!text) return "";
            return text.trim()
                .replace(/[أإآا]/g, "ا")
                .replace(/[ىي]/g, "ي")
                .replace(/[ةه]/g, "ه")
                .replace(/\s+/g, " "); // إزالة المسافات الزائدة
        }

        async function verifyAndSend() {
            const inputName = document.getElementById('verifyName').value;
            const inputPhone = document.getElementById('verifyPhone').value;

            if (!inputName || !inputPhone) {
                alert("برجاء إدخال البيانات المطلوبة");
                return;
            }

            // جلب المستخدمين من الداتا بيز
            // ملاحظة: هنضطر نجلب البيانات ونقارن برمجياً لأن السيرفر مش بيعرف الـ CleanText بتاعنا
            const { data: users, error } = await _supabase
                .from('profiles')
                .select('*')
                .eq('phone', inputPhone);

            if (error || users.length === 0) {
                alert("رقم الهاتف غير مسجل أو البيانات غير صحيحة");
                return;
            }

            const foundUser = users.find(u => cleanText(u.full_name) === cleanText(inputName));

            if (foundUser) {
                // تجهيز الرسالة للواتساب
                const adminPhone = "201119859192";
                const message = `طلب استعادة حساب (حذف تسجيل)
--------------------------
الاسم: ${foundUser.full_name}
رقم الهاتف: ${foundUser.phone}
اسم المستخدم: ${foundUser.username}
الفرقة: ${foundUser.academic_year}
الشعبة: ${foundUser.major}
--------------------------
نرجو حذف الحساب لأتمكن من التسجيل مرة أخرى بصورة صحيحة.`;

                const encodedMsg = encodeURIComponent(message);
                const whatsappURL = `https://wa.me/${adminPhone}?text=${encodedMsg}`;

                alert("تم التحقق بنجاح! سيتم توجيهك الآن للواتساب لإرسال البيانات للأدمن.");
                window.location.href = whatsappURL;
            } else {
                alert("الاسم غير متطابق مع رقم الهاتف المسجل. تأكد من كتابة اسمك كما سجلته أول مرة.");
            }
        }
    </script>
</body>
</html>
